<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="springboot.shop.repository.mapper.OrderMapper">
    <insert id="save" useGeneratedKeys="true" keyProperty="orderId">
        insert into orders(member_id, order_date, status)
        values (#{memberId}, now(), #{status})
    </insert>

    <select id="findByMemberId" resultMap="orderResult">
        select o.orders_id, o.member_id, o.order_date, o.status,
               oi.order_item_id, oi.item_id, oi.count,
               i.name, i.price,
               ii.item_img_id, ii.img_name, ii.origin_img_name, ii.paths, ii.orders
        from orders o
        inner join order_item oi on o.orders_id = oi.orders_id
        inner join item i on oi.item_id = i.item_id
        inner join item_img ii on i.item_id = ii.item_id
        where o.member_id = ${memberId}
        order by orders_id desc;
    </select>
    <resultMap id="orderResult" type="Order">
        <id property="orderId" column="orders_id"/>
        <result property="memberId" column="member_id"/>
        <result property="orderDate" column="order_date"/>
        <result property="status" column="status"/>
        <collection property="orderItemList" javaType="java.util.ArrayList" ofType="OrderItem">
            <id property="orderItemId" column="order_item_id" />
            <result property="orderId" column="orders_id"/>
            <result property="itemId" column="item_id"/>
            <result property="count" column="count"/>
            <association property="item" javaType="Item">
                <id property="itemId" column="item_id"/>
                <result property="name" column="name" />
                <result property="price" column="price" />
                <result property="quantity" column="quantity" />
                <collection property="itemImageList" javaType="java.util.ArrayList" ofType="ItemImage">
                    <id property="itemImgId" column="item_img_id"/>
                    <result property="itemId" column="item_id" />
                    <result property="imgName" column="img_name" />
                    <result property="originImgName" column="origin_img_name" />
                    <result property="paths" column="paths" />
                    <result property="orders" column="orders" />
                </collection>
            </association>
        </collection>
    </resultMap>
</mapper>